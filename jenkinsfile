 pipeline {
    agent any

    parameters {
        string(name: 'BRANCH', defaultValue: 'master', description: 'Git branch to build from')
        string(name: 'PORT', defaultValue: '5000', description: 'Port to expose the app on')
        string(name: 'CONTAINER_NAME', defaultValue: 'realimage', description: 'Docker container name')
    }

    environment {
        DOCKER_IMAGE = "siddhartha200340/real-image:latest"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: "${params.BRANCH}",
                    url: 'https://github.com/siddha200340/my-real-life-project.git'
            }
        }

        stage("Install Dependencies & Run Tests") {
            steps {
                bat '''
                python -m pip install --upgrade pip
                pip install -r requirements.txt
                pytest'''
            }
        }

        stage('Build Docker Image') {
            steps {
                bat "docker build -t %DOCKER_IMAGE% ."
            }
        }

        stage('Deploy Container') {
            steps {
                bat """
                docker rm -f ${params.CONTAINER_NAME} || exit 0
                docker run -d -p ${params.PORT}:5000 --name ${params.CONTAINER_NAME} %DOCKER_IMAGE%
                """
            }
        }
    }
}
